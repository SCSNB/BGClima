<!-- Top anchor for scrolling -->
<div #topElement></div>

<div class="product-details-container" *ngIf="product">
  <!-- Breadcrumbs -->
  <nav class="breadcrumbs">
    <a routerLink="/">Начало</a> > 
    <a [routerLink]="['/products']">Продукти</a> > 
    <span>{{product.name}}</span>
  </nav>

  <!-- Main Product Section -->
  <div class="product-main">
    <!-- Product Images -->
    <div class="product-gallery">
      <div class="main-image">
        <div *ngIf="!selectedImage" class="no-image">
          <p>Няма налична снимка</p>
          <p>Очакван път: {{ 'assets/no-image.png' }}</p>
        </div>
        <img 
          *ngIf="selectedImage" 
          [src]="selectedImage" 
          [alt]="product.name" 
          (error)="handleImageError($event)" />
        <div *ngIf="selectedImage" class="debug-info">
          <p>URL: {{ selectedImage }}</p>
          <p>Валиден URL: {{ isUrlValid(selectedImage) ? 'Да' : 'Не' }}</p>
        </div>
      </div>
      <div class="thumbnail-container">
        <div 
          *ngFor="let image of product.images" 
          class="thumbnail" 
          [class.active]="selectedImage === image.url"
          (click)="selectImage(image.url)">
          <img [src]="getImageUrl(image.url)" [alt]="product.name + ' thumbnail'" />
        </div>
      </div>
    </div>

    <!-- Product Info -->
    <div class="product-info">
      <h1 class="product-title">{{product.name}}</h1>
      
      <!-- Brand and Availability -->
      <div class="product-meta">
        <span class="brand" *ngIf="product.brand">
          <strong>Марка:</strong> {{product.brand.name}}
        </span>
        <span class="availability" [class.in-stock]="product.stockQuantity > 0" [class.out-of-stock]="product.stockQuantity <= 0">
          {{product.stockQuantity > 0 ? 'В наличност' : 'Не е наличен'}}
        </span>
      </div>

      <!-- Price -->
      <div class="price-section">
        <div class="current-price">
          <span class="price">{{product.price | number:'1.2-2'}} лв.</span>
          <span class="price-eur">/ {{(product.price / 1.9558) | number:'1.2-2'}} €</span>
        </div>
        <div class="old-price" *ngIf="product.oldPrice">
          <span class="price">{{product.oldPrice | number:'1.2-2'}} лв.</span>
          <span class="price-eur">/ {{(product.oldPrice / 1.9558) | number:'1.2-2'}} €</span>
        </div>
      </div>

      <!-- Short Description -->
      <div class="short-description" *ngIf="product.description">
        <h3>Кратко описание</h3>
        <p>{{product.description | slice:0:200}}...</p>
      </div>

      <!-- Product actions removed as per request -->

      <!-- Product Meta -->
      <div class="product-meta-details">
        <div class="meta-item" *ngIf="product.sku">
          <span class="meta-label">Код на продукта:</span>
          <span class="meta-value">{{product.sku}}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Категория:</span>
          <span class="meta-value">{{product.productType?.name || 'N/A'}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="product-tabs">
    <div class="tabs-header">
      <button 
        *ngFor="let tab of tabs; let i = index"
        [class.active]="activeTab === i"
        (click)="setActiveTab(i)"
        class="tab-button">
        {{tab}}
      </button>
    </div>

    <div class="tab-content">
      <!-- Description Tab -->
      <div *ngIf="activeTab === 0" class="tab-pane">
        <h3>Описание на продукта</h3>
        <div [innerHTML]="product.description"></div>
      </div>

      <!-- Specifications Tab -->
      <div *ngIf="activeTab === 1" class="tab-pane">
        <h3>Технически характеристики</h3>
        <div class="specs-grid">
          <div class="spec-row" *ngFor="let attr of product.attributes">
            <div class="spec-name">{{attr.attributeKey}}</div>
            <div class="spec-value">{{attr.attributeValue || 'N/A'}}</div>
          </div>
        </div>
      </div>

      <!-- Delivery Tab -->
      <div *ngIf="activeTab === 2" class="tab-pane">
        <h3>Доставка и плащане</h3>
        <p>Доставката се извършва чрез куриерска фирма до адрес на територията на България.</p>
        <p>Срок за доставка: 1-3 работни дни след потвърждение на поръчката.</p>
        <p>Начини на плащане: Наложен платеж, банков превод, кредитна/дебитна карта.</p>
      </div>

      <!-- Warranty Tab -->
      <div *ngIf="activeTab === 3" class="tab-pane">
        <h3>Гаранционни условия</h3>
        <p>Всички продукти се доставят с пълна гаранция от производителя.</p>
        <p>Гаранционният срок е 24 месеца от датата на покупка.</p>
        <p>При необходимост от гаранционно обслужване, моля свържете се с нашия екип.</p>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  <div class="related-products" *ngIf="relatedProducts.length > 0">
    <h2>Свързани продукти</h2>
    <div class="related-products-grid">
      <div class="related-product" *ngFor="let related of relatedProducts">
        <a [routerLink]="['/product', related.id]">
          <img [src]="related.imageUrl || 'assets/no-image.png'" [alt]="related.name" />
          <h3>{{related.name}}</h3>
          <div class="price">{{related.price | number:'1.2-2'}} лв.</div>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <mat-spinner></mat-spinner>
  <p>Зареждане на детайли за продукта...</p>
</div>

<!-- Error State -->
<div *ngIf="error" class="error-state">
  <mat-icon>error_outline</mat-icon>
  <p>{{error}}</p>
  <button mat-button color="primary" (click)="loadProduct()">Опитайте отново</button>
</div>
